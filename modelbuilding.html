

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>4. Building models &mdash; PyMC 2.3 documentation</title>
    
    <link rel="stylesheet" href="_static/default.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '2.3',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="http://mathjax.connectmv.com/MathJax.js?config=default"></script>
    <link rel="top" title="PyMC 2.3 documentation" href="index.html" />
    <link rel="next" title="5. Fitting Models" href="modelfitting.html" />
    <link rel="prev" title="3. Tutorial" href="tutorial.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="modelfitting.html" title="5. Fitting Models"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="tutorial.html" title="3. Tutorial"
             accesskey="P">previous</a> |</li>
        <li><a href="index.html">PyMC 2.3 documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="building-models">
<span id="chap-modelbuilding"></span><h1>4. Building models<a class="headerlink" href="#building-models" title="Permalink to this headline">¶</a></h1>
<p>Bayesian inference begins with specification of a probability model relating
unknown variables to data. PyMC provides three basic building blocks for
Bayesian probability models: <tt class="docutils literal"><span class="pre">Stochastic</span></tt>, <tt class="docutils literal"><span class="pre">Deterministic</span></tt> and
<tt class="docutils literal"><span class="pre">Potential</span></tt>.</p>
<p>A <tt class="docutils literal"><span class="pre">Stochastic</span></tt> object represents a variable whose value is not completely
determined by its parents, and a <tt class="docutils literal"><span class="pre">Deterministic</span></tt> object represents a variable
that is entirely determined by its parents. In object-oriented programming
parlance, <tt class="docutils literal"><span class="pre">Stochastic</span></tt> and <tt class="docutils literal"><span class="pre">Deterministic</span></tt> are subclasses of the
<tt class="docutils literal"><span class="pre">Variable</span></tt> class, which only serves as a template for other classes and is
never actually implemented in models.</p>
<p>The third basic class, <tt class="docutils literal"><span class="pre">Potential</span></tt>, represents &#8216;factor potentials&#8217;
(<a class="reference internal" href="references.html#lauritzen1990">[Lauritzen1990]</a>,[Jordan2004]_), which are <em>not</em> variables but simply
log-likelihood terms and/or constraints that are multiplied into joint
distributions to modify them. <tt class="docutils literal"><span class="pre">Potential</span></tt> and <tt class="docutils literal"><span class="pre">Variable</span></tt> are subclasses of
<tt class="docutils literal"><span class="pre">Node</span></tt>.</p>
<p>PyMC probability models are simply linked groups of <tt class="docutils literal"><span class="pre">Stochastic</span></tt>,
<tt class="docutils literal"><span class="pre">Deterministic</span></tt> and <tt class="docutils literal"><span class="pre">Potential</span></tt> objects. These objects have very limited
awareness of the models in which they are embedded and do not themselves
possess methods for updating their values in fitting algorithms. Objects
responsible for fitting probability models are described in chapter
<a class="reference internal" href="modelfitting.html#chap-modelfitting"><em>Fitting Models</em></a>.</p>
<div class="section" id="the-stochastic-class">
<span id="stochastic"></span><h2>4.1. The Stochastic class<a class="headerlink" href="#the-stochastic-class" title="Permalink to this headline">¶</a></h2>
<p>A stochastic variable has the following primary attributes:</p>
<dl class="docutils">
<dt><tt class="docutils literal"><span class="pre">value</span></tt>:</dt>
<dd>The variable&#8217;s current value.</dd>
<dt><tt class="docutils literal"><span class="pre">logp</span></tt>:</dt>
<dd>The log-probability of the variable&#8217;s current value given the values of its parents.</dd>
</dl>
<p>A stochastic variable can optionally be endowed with a method called
<tt class="docutils literal"><span class="pre">random</span></tt>, which draws a value for the variable given the values of its
parents <a class="footnote-reference" href="#id15" id="id2">[1]</a>. Stochastic objects have the following additional attributes:</p>
<dl class="docutils">
<dt><tt class="docutils literal"><span class="pre">parents</span></tt>:</dt>
<dd>A dictionary containing the variable&#8217;s parents. The keys of the dictionary
correspond to the names assigned to the variable&#8217;s parents by the variable,
and the values correspond to the actual parents. For example, the keys of
<span class="math">\(s\)</span>&#8216;s parents dictionary in model (<a href="#equation-disastermodel">(?)</a>) would be
<tt class="docutils literal"><span class="pre">'t_l'</span></tt> and <tt class="docutils literal"><span class="pre">'t_h'</span></tt>. Thanks to Python&#8217;s dynamic typing, the actual
parents (<em>i.e.</em> the values of the dictionary) may be of any class or type.</dd>
<dt><tt class="docutils literal"><span class="pre">children</span></tt>:</dt>
<dd>A set containing the variable&#8217;s children.</dd>
<dt><tt class="docutils literal"><span class="pre">extended_parents</span></tt>:</dt>
<dd>A set containing all the stochastic variables on which the variable depends
either directly or via a sequence of deterministic variables. If the value
of any of these variables changes, the variable will need to recompute its
log-probability.</dd>
<dt><tt class="docutils literal"><span class="pre">extended_children</span></tt>:</dt>
<dd>A set containing all the stochastic variables and potentials that depend on
the variable either directly or via a sequence of deterministic variables.
If the variable&#8217;s value changes, all of these variables will need to
recompute their log-probabilities.</dd>
<dt><tt class="docutils literal"><span class="pre">observed</span></tt>:</dt>
<dd>A flag (boolean) indicating whether the variable&#8217;s value has been observed
(is fixed).</dd>
<dt><tt class="docutils literal"><span class="pre">dtype</span></tt>:</dt>
<dd>A NumPy dtype object (such as <tt class="docutils literal"><span class="pre">numpy.int</span></tt>) that specifies the type of the
variable&#8217;s value to fitting methods. If this is <tt class="docutils literal"><span class="pre">None</span></tt> (default) then no
type is enforced.</dd>
</dl>
<div class="section" id="creation-of-stochastic-variables">
<h3>4.1.1. Creation of stochastic variables<a class="headerlink" href="#creation-of-stochastic-variables" title="Permalink to this headline">¶</a></h3>
<p>There are three main ways to create stochastic variables, called the
<strong>automatic</strong>, <strong>decorator</strong>, and <strong>direct</strong> interfaces.</p>
<dl class="docutils">
<dt><strong>Automatic</strong></dt>
<dd><p class="first">Stochastic variables with standard distributions provided by PyMC (see
chapter <a class="reference internal" href="distributions.html#chap-distributions"><em>Probability distributions</em></a>) can be created in a single line using
special subclasses of <tt class="docutils literal"><span class="pre">Stochastic</span></tt>. For example, the uniformly-distributed
discrete variable <span class="math">\(switchpoint\)</span> in (<a href="#equation-disaster_model">(?)</a>) is created
using the automatic interface as follows:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">switchpoint</span> <span class="o">=</span> <span class="n">DiscreteUniform</span><span class="p">(</span><span class="s">&#39;switchpoint&#39;</span><span class="p">,</span> <span class="n">lower</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">upper</span><span class="o">=</span><span class="mi">110</span><span class="p">,</span> <span class="n">doc</span><span class="o">=</span><span class="s">&#39;Switchpoint[year]&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>In addition to the classes in chapter <a class="reference internal" href="distributions.html#chap-distributions"><em>Probability distributions</em></a>,
<tt class="docutils literal"><span class="pre">scipy.stats.distributions</span></tt>&#8216; random variable classes are wrapped as
<tt class="docutils literal"><span class="pre">Stochastic</span></tt> subclasses if SciPy is installed. These distributions are in
the submodule <tt class="docutils literal"><span class="pre">pymc.SciPyDistributions</span></tt>.</p>
<p class="last">Users can call the class factory <tt class="docutils literal"><span class="pre">stochastic_from_dist</span></tt> to produce
<tt class="docutils literal"><span class="pre">Stochastic</span></tt> subclasses of their own from probability distributions not
included with PyMC.</p>
</dd>
<dt><strong>Decorator</strong></dt>
<dd><p class="first">Uniformly-distributed discrete stochastic variable <span class="math">\(switchpoint\)</span> in
(<a href="#equation-disaster_model">(?)</a>) could alternatively be created from a function that
computes its log-probability as follows:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="nd">@pymc.stochastic</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">switchpoint</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="mi">1900</span><span class="p">,</span> <span class="n">t_l</span><span class="o">=</span><span class="mi">1851</span><span class="p">,</span> <span class="n">t_h</span><span class="o">=</span><span class="mi">1962</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The switchpoint for the rate of disaster occurrence.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">value</span> <span class="o">&gt;</span> <span class="n">t_h</span> <span class="ow">or</span> <span class="n">value</span> <span class="o">&lt;</span> <span class="n">t_l</span><span class="p">:</span>
        <span class="c"># Invalid values</span>
        <span class="k">return</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c"># Uniform log-likelihood</span>
        <span class="k">return</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">t_h</span> <span class="o">-</span> <span class="n">t_l</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
<p>Note that this is a simple Python function preceded by a Python expression
called a <strong>decorator</strong> <a class="reference internal" href="references.html#vanrossum2010">[vanRossum2010]</a>, here called <tt class="docutils literal"><span class="pre">&#64;stochastic</span></tt>.
Generally, decorators enhance functions with additional properties or
functionality. The <tt class="docutils literal"><span class="pre">Stochastic</span></tt> object produced by the <tt class="docutils literal"><span class="pre">&#64;stochastic</span></tt>
decorator will evaluate its log-probability using the function
<span class="math">\(switchpoint\)</span>. The <tt class="docutils literal"><span class="pre">value</span></tt> argument, which is required, provides an
initial value for the variable. The remaining arguments will be assigned as
parents of <span class="math">\(switchpoint\)</span> (<em>i.e.</em> they will populate the <tt class="docutils literal"><span class="pre">parents</span></tt>
dictionary).</p>
<p>To emphasize, the Python function decorated by <tt class="docutils literal"><span class="pre">&#64;stochastic</span></tt> should
compute the <em>log</em>-density or <em>log</em>-probability of the variable. That is why
the return value in the example above is <span class="math">\(-\log(t_h-t_l+1)\)</span> rather
than <span class="math">\(1/(t_h-t_l+1)\)</span>.</p>
<p>The <tt class="docutils literal"><span class="pre">value</span></tt> and parents of stochastic variables may be any objects,
provided the log-probability function returns a real number (<tt class="docutils literal"><span class="pre">float</span></tt>).
PyMC and SciPy both provide implementations of several standard probability
distributions that may be helpful for creating custom stochastic variables.</p>
<p>The decorator stochastic can take any of the arguments
<tt class="docutils literal"><span class="pre">Stochastic.__init__</span></tt> takes except <tt class="docutils literal"><span class="pre">parents</span></tt>, <tt class="docutils literal"><span class="pre">logp</span></tt>, <tt class="docutils literal"><span class="pre">random</span></tt>,
<tt class="docutils literal"><span class="pre">doc</span></tt> and <tt class="docutils literal"><span class="pre">value</span></tt>. These arguments include <tt class="docutils literal"><span class="pre">trace</span></tt>, <tt class="docutils literal"><span class="pre">plot</span></tt>,
<tt class="docutils literal"><span class="pre">verbose</span></tt>, <tt class="docutils literal"><span class="pre">dtype</span></tt>, <tt class="docutils literal"><span class="pre">rseed</span></tt> and <tt class="docutils literal"><span class="pre">name</span></tt>. The decorator interface has
a slightly more complex implementation which allows you to specify a
<tt class="docutils literal"><span class="pre">random</span></tt> method for sampling the stochastic variable&#8217;s value conditional
on its parents.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="nd">@pymc.stochastic</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">switchpoint</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="mi">1900</span><span class="p">,</span> <span class="n">t_l</span><span class="o">=</span><span class="mi">1851</span><span class="p">,</span> <span class="n">t_h</span><span class="o">=</span><span class="mi">1962</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The switchpoint for the rate of disaster occurrence.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">logp</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">t_l</span><span class="p">,</span> <span class="n">t_h</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">value</span> <span class="o">&gt;</span> <span class="n">t_h</span> <span class="ow">or</span> <span class="n">value</span> <span class="o">&lt;</span> <span class="n">t_l</span><span class="p">:</span>
            <span class="k">return</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">t_h</span> <span class="o">-</span> <span class="n">t_l</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">random</span><span class="p">(</span><span class="n">t_l</span><span class="p">,</span> <span class="n">t_h</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">numpy.random</span> <span class="kn">import</span> <span class="n">random</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span> <span class="p">(</span><span class="n">t_l</span> <span class="o">-</span> <span class="n">t_h</span><span class="p">)</span> <span class="o">*</span> <span class="n">random</span><span class="p">()</span> <span class="p">)</span> <span class="o">+</span> <span class="n">t_l</span>
</pre></div>
</div>
<p class="last">The stochastic variable again gets its name, docstring and parents from
function <span class="math">\(switchpoint\)</span>, but in this case it will evaluate its
log-probability using the <tt class="docutils literal"><span class="pre">logp</span></tt> function. The <tt class="docutils literal"><span class="pre">random</span></tt> function will be
used when <tt class="docutils literal"><span class="pre">switchpoint.random()</span></tt> is called. Note that <tt class="docutils literal"><span class="pre">random</span></tt> doesn&#8217;t
take a <tt class="docutils literal"><span class="pre">value</span></tt> argument, as it generates values itself.</p>
</dd>
<dt><strong>Direct</strong></dt>
<dd><p class="first">It&#8217;s possible to instantiate <tt class="docutils literal"><span class="pre">Stochastic</span></tt> directly:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">switchpoint_logp</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">t_l</span><span class="p">,</span> <span class="n">t_h</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">value</span> <span class="o">&gt;</span> <span class="n">t_h</span> <span class="ow">or</span> <span class="n">value</span> <span class="o">&lt;</span> <span class="n">t_l</span><span class="p">:</span>
        <span class="k">return</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">t_h</span> <span class="o">-</span> <span class="n">t_l</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">switchpoint_rand</span><span class="p">(</span><span class="n">t_l</span><span class="p">,</span> <span class="n">t_h</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">numpy.random</span> <span class="kn">import</span> <span class="n">random</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span> <span class="p">(</span><span class="n">t_l</span> <span class="o">-</span> <span class="n">t_h</span><span class="p">)</span> <span class="o">*</span> <span class="n">random</span><span class="p">()</span> <span class="p">)</span> <span class="o">+</span> <span class="n">t_l</span>

<span class="n">switchpoint</span> <span class="o">=</span> <span class="n">Stochastic</span><span class="p">(</span> <span class="n">logp</span> <span class="o">=</span> <span class="n">switchpoint_logp</span><span class="p">,</span>
                <span class="n">doc</span> <span class="o">=</span> <span class="s">&#39;The switchpoint for the rate of disaster occurrence.&#39;</span><span class="p">,</span>
                <span class="n">name</span> <span class="o">=</span> <span class="s">&#39;switchpoint&#39;</span><span class="p">,</span>
                <span class="n">parents</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;t_l&#39;</span><span class="p">:</span> <span class="mi">1851</span><span class="p">,</span> <span class="s">&#39;t_h&#39;</span><span class="p">:</span> <span class="mi">1962</span><span class="p">},</span>
                <span class="n">random</span> <span class="o">=</span> <span class="n">switchpoint_rand</span><span class="p">,</span>
                <span class="n">trace</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
                <span class="n">value</span> <span class="o">=</span> <span class="mi">1900</span><span class="p">,</span>
                <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
                <span class="n">rseed</span> <span class="o">=</span> <span class="mf">1.</span><span class="p">,</span>
                <span class="n">observed</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
                <span class="n">cache_depth</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
                <span class="n">plot</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                <span class="n">verbose</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
<p class="last">Notice that the log-probability and random variate functions are specified
externally and passed to <tt class="docutils literal"><span class="pre">Stochastic</span></tt> as arguments. This is a rather
awkward way to instantiate a stochastic variable; consequently, such
implementations should be rare.</p>
</dd>
</dl>
<div class="topic" id="warning">
<p class="topic-title first">A Warning: Don&#8217;t update stochastic variables&#8217; values in-place</p>
<p><tt class="docutils literal"><span class="pre">Stochastic</span></tt> objects&#8217; values should not be updated in-place. This
confuses PyMC&#8217;s caching scheme and corrupts the process used for accepting
or rejecting proposed values in the MCMC algorithm. The only way a
stochastic variable&#8217;s value should be updated is using statements of the
following form:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">A</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">new_value</span>
</pre></div>
</div>
<p>The following are in-place updates and should _never_ be used:</p>
<div class="highlight-python"><pre>* ``A.value += 3``
* ``A.value[2,1] = 5``
* ``A.value.attribute = new_attribute_value``</pre>
</div>
<p>This restriction becomes onerous if a step method proposes values for the
elements of an array-valued variable separately. In this case, it may be
preferable to partition the variable into several scalar-valued variables
stored in an array or list.</p>
</div>
</div>
</div>
<div class="section" id="data">
<span id="id4"></span><h2>4.2. Data<a class="headerlink" href="#data" title="Permalink to this headline">¶</a></h2>
<p>Data are represented by <tt class="docutils literal"><span class="pre">Stochastic</span></tt> objects whose <tt class="docutils literal"><span class="pre">observed</span></tt> attribute is
set to <tt class="docutils literal"><span class="pre">True</span></tt>. If a stochastic variable&#8217;s <tt class="docutils literal"><span class="pre">observed</span></tt> flag is <tt class="docutils literal"><span class="pre">True</span></tt>, its
value cannot be changed, and it won&#8217;t be sampled by the fitting method.</p>
<div class="section" id="declaring-stochastic-variables-to-be-data">
<h3>4.2.1. Declaring stochastic variables to be data<a class="headerlink" href="#declaring-stochastic-variables-to-be-data" title="Permalink to this headline">¶</a></h3>
<p>In each interface, an optional keyword argument <tt class="docutils literal"><span class="pre">observed</span></tt> can be set to
<tt class="docutils literal"><span class="pre">True</span></tt>. In the decorator interface, this argument is added to the
<tt class="docutils literal"><span class="pre">&#64;stochastic</span></tt> decorator:</p>
<div class="highlight-python"><pre>@pymc.stochastic(observed=True)</pre>
</div>
<p>In the other interfaces, the <tt class="docutils literal"><span class="pre">observed=True</span></tt> argument is added to the
instantiation of the <tt class="docutils literal"><span class="pre">Stochastic</span></tt>, or its subclass:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">x</span> <span class="o">=</span> <span class="n">pymc</span><span class="o">.</span><span class="n">Binomial</span><span class="p">(</span><span class="s">&#39;x&#39;</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="n">p</span><span class="p">,</span> <span class="n">observed</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>
</div>
<p>Alternatively, in the decorator interface only, a <tt class="docutils literal"><span class="pre">Stochastic</span></tt> object&#8217;s
<tt class="docutils literal"><span class="pre">observed</span></tt> flag can be set to true by stacking an <tt class="docutils literal"><span class="pre">&#64;observed</span></tt> decorator on
top of the <tt class="docutils literal"><span class="pre">&#64;stochastic</span></tt> decorator:</p>
<div class="highlight-python"><pre>@pymc.observed(dtype=int)
def ...</pre>
</div>
</div>
</div>
<div class="section" id="the-deterministic-class">
<span id="deterministic"></span><h2>4.3. The Deterministic class<a class="headerlink" href="#the-deterministic-class" title="Permalink to this headline">¶</a></h2>
<p>The <tt class="docutils literal"><span class="pre">Deterministic</span></tt> class represents variables whose values are completely
determined by the values of their parents. For example, in model
(<a href="#equation-disaster_model">(?)</a>), <span class="math">\(rate\)</span> is a <tt class="docutils literal"><span class="pre">deterministic</span></tt> variable. Recall it
was defined by</p>
<div class="math">
\[\begin{eqnarray*}
    r_t=\left\{\begin{array}{ll}
        e & t\le s\\ l & t>s
        \end{array}\right.,
\end{eqnarray*}\]</div><p>so <span class="math">\(rate\)</span>&#8216;s value can be computed exactly from the values of its parents
<span class="math">\(early_mean\)</span>, <span class="math">\(late_mean\)</span> and <span class="math">\(switchpoint\)</span>.</p>
<p>A <tt class="docutils literal"><span class="pre">deterministic</span></tt> variable&#8217;s most important attribute is <tt class="docutils literal"><span class="pre">value</span></tt>, which
gives the current value of the variable given the values of its parents. Like
<tt class="docutils literal"><span class="pre">Stochastic</span></tt>&#8216;s <tt class="docutils literal"><span class="pre">logp</span></tt> attribute, this attribute is computed on-demand and
cached for efficiency.</p>
<p>A Deterministic variable has the following additional attributes:</p>
<dl class="docutils">
<dt><tt class="docutils literal"><span class="pre">parents</span></tt>:</dt>
<dd>A dictionary containing the variable&#8217;s parents. The keys of the dictionary
correspond to the names assigned to the variable&#8217;s parents by the variable,
and the values correspond to the actual parents.</dd>
<dt><tt class="docutils literal"><span class="pre">children</span></tt>:</dt>
<dd>A set containing the variable&#8217;s children, which must be nodes.</dd>
</dl>
<p>Deterministic variables have no methods.</p>
<div class="section" id="creation-of-deterministic-variables">
<h3>4.3.1. Creation of deterministic variables<a class="headerlink" href="#creation-of-deterministic-variables" title="Permalink to this headline">¶</a></h3>
<p>Deterministic variables are less complicated than stochastic variables, and
have similar <strong>automatic</strong>, <strong>decorator</strong>, and <strong>direct</strong> interfaces:</p>
<dl class="docutils">
<dt><strong>Automatic</strong></dt>
<dd><p class="first">A handful of common functions have been wrapped in Deterministic objects.
These are brief enough to list:</p>
<dl class="docutils">
<dt><tt class="docutils literal"><span class="pre">LinearCombination</span></tt>:</dt>
<dd>Has two parents <span class="math">\(x\)</span> and <span class="math">\(y\)</span>, both of which must be iterable
(<em>i.e.</em> vector-valued). This function returns:</dd>
<dt><tt class="docutils literal"><span class="pre">Index</span></tt>:</dt>
<dd><p class="first">Has two parents <span class="math">\(x\)</span> and <tt class="docutils literal"><span class="pre">index</span></tt>. <span class="math">\(x\)</span> must be iterables,
<tt class="docutils literal"><span class="pre">index</span></tt> must be valued as an integer. The value of an <tt class="docutils literal"><span class="pre">index</span></tt> is:</p>
<p class="last"><tt class="docutils literal"><span class="pre">Index</span></tt> is useful for implementing dynamic models, in which the
parent-child connections change.</p>
</dd>
<dt><tt class="docutils literal"><span class="pre">Lambda</span></tt>:</dt>
<dd>Converts an anonymous function (in Python, called <strong>lambda functions</strong>)
to a <tt class="docutils literal"><span class="pre">Deterministic</span></tt> instance on a single line.</dd>
<dt><tt class="docutils literal"><span class="pre">CompletedDirichlet</span></tt>:</dt>
<dd>PyMC represents Dirichlet variables of length <span class="math">\(k\)</span> by the first
<span class="math">\(k-1\)</span> elements; since they must sum to 1, the <span class="math">\(k^{th}\)</span>
element is determined by the others. <tt class="docutils literal"><span class="pre">CompletedDirichlet</span></tt> appends the
<span class="math">\(k^{th}\)</span> element to the value of its parent <span class="math">\(D\)</span>.</dd>
<dt><tt class="docutils literal"><span class="pre">Logit</span></tt>, <tt class="docutils literal"><span class="pre">InvLogit</span></tt>, <tt class="docutils literal"><span class="pre">StukelLogit</span></tt>, <tt class="docutils literal"><span class="pre">StukelInvLogit</span></tt>:</dt>
<dd>Common link functions for generalized linear models, and their inverses.</dd>
</dl>
<p class="last">It’s a good idea to use these classes when feasible in order to give hints
to step methods.</p>
</dd>
<dt><strong>Elementary operations on variables</strong></dt>
<dd><p class="first">Certain elementary operations on variables create deterministic variables. For example:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">x</span> <span class="o">=</span> <span class="n">pymc</span><span class="o">.</span><span class="n">MvNormalCov</span><span class="p">(</span><span class="s">&#39;x&#39;</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">y</span> <span class="o">=</span> <span class="n">pymc</span><span class="o">.</span><span class="n">MvNormalCov</span><span class="p">(</span><span class="s">&#39;y&#39;</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">print</span> <span class="n">x</span><span class="o">+</span><span class="n">y</span>
<span class="go">&lt;pymc.PyMCObjects.Deterministic &#39;(x_add_y)&#39; at 0x105c3bd10&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">print</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="go">&lt;pymc.CommonDeterministics.Index &#39;x[0]&#39; at 0x105c52390&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">print</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">y</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
<span class="go">&lt;pymc.PyMCObjects.Deterministic &#39;(x[1]_add_y[2])&#39; at 0x105c52410&gt;</span>
</pre></div>
</div>
<p class="last">All the objects thus created have <tt class="docutils literal"><span class="pre">trace=False</span></tt> and <tt class="docutils literal"><span class="pre">plot=False</span></tt> by
default. This convenient method of generating simple deterministics was
inspired by <a class="reference internal" href="references.html#kerman2004">[Kerman2004]</a>.</p>
</dd>
<dt><strong>Decorator</strong></dt>
<dd><p class="first">A deterministic variable can be created via a decorator in a way very
similar to <tt class="docutils literal"><span class="pre">Stochastic</span></tt>&#8216;s decorator interface:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="nd">@deterministic</span><span class="p">(</span><span class="n">plot</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">rate</span><span class="p">(</span><span class="n">s</span><span class="o">=</span><span class="n">switchpoint</span><span class="p">,</span> <span class="n">e</span><span class="o">=</span><span class="n">early_mean</span><span class="p">,</span> <span class="n">l</span><span class="o">=</span><span class="n">late_mean</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Concatenate Poisson means &#39;&#39;&#39;</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">empty</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">disasters_array</span><span class="p">))</span>
    <span class="n">out</span><span class="p">[:</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="n">e</span>
    <span class="n">out</span><span class="p">[</span><span class="n">s</span><span class="p">:]</span> <span class="o">=</span> <span class="n">l</span>
    <span class="k">return</span> <span class="n">out</span>
</pre></div>
</div>
<p class="last">Notice that rather than returning the log-probability, as is the case for
<tt class="docutils literal"><span class="pre">Stochastic</span></tt> objects, the function returns the value of the deterministic
object, given its parents. This return value may be of any type, as is
suitable for the problem at hand. Also notice that, unlike for
<tt class="docutils literal"><span class="pre">Stochastic</span></tt> objects, there is no <tt class="docutils literal"><span class="pre">value</span></tt> argument passed, since the
value is calculated deterministically by the function itself. Arguments&#8217;
keys and values are converted into a parent dictionary as with
<tt class="docutils literal"><span class="pre">Stochastic</span></tt>&#8216;s short interface. The <tt class="docutils literal"><span class="pre">deterministic</span></tt> decorator can take
<tt class="docutils literal"><span class="pre">trace</span></tt>, <tt class="docutils literal"><span class="pre">verbose</span></tt> and <tt class="docutils literal"><span class="pre">plot</span></tt> arguments, like the <tt class="docutils literal"><span class="pre">stochastic</span></tt>
decorator <a class="footnote-reference" href="#id16" id="id6">[2]</a>.</p>
</dd>
<dt><strong>Direct</strong></dt>
<dd><p class="first"><tt class="docutils literal"><span class="pre">Deterministic</span></tt> objects can also be instantiated directly:</p>
<div class="last highlight-python"><pre>def rate_eval(switchpoint = s, early_rate = e, late_rate = l):
    value = zeros(N)
    value[:switchpoint] = early_rate
    value[switchpoint:] = late_rate
    return value

rate = pymc.Deterministic(eval = rate_eval,
                  name = 'rate',
                  parents = {'switchpoint': switchpoint,
                          'early_mean': early_mean,
                          'late_mean': late_mean}),
                  doc = 'The rate of disaster occurrence.',
                  trace = True,
                  verbose = 0,
                  dtype=float,
                  plot=False,
                  cache_depth = 2)</pre>
</div>
</dd>
</dl>
</div>
</div>
<div class="section" id="containers">
<span id="id7"></span><h2>4.4. Containers<a class="headerlink" href="#containers" title="Permalink to this headline">¶</a></h2>
<p>In some situations it would be inconvenient to assign a unique label to each
parent of some variable. Consider <span class="math">\(y\)</span> in the following model:</p>
<div class="math">
\[\begin{align*}
    x_0 &\sim N (0,\tau_x)\\
    x_{i+1}|x_i &\sim \text{N}(x_i, \tau_x)\\
    &i=0,\ldots, N-2\\
    y|x &\sim N \left(\sum_{i=0}^{N-1}x_i^2,\tau_y\right)
\end{align*}\]</div><p>Here, <span class="math">\(y\)</span> depends on every element of the Markov chain <span class="math">\(x\)</span>, but we
wouldn&#8217;t want to manually enter <span class="math">\(N\)</span> parent labels <tt class="docutils literal"><span class="pre">`x_0'</span></tt>, <tt class="docutils literal"><span class="pre">`x_1'</span></tt>,
etc.</p>
<p>This situation can be handled naturally in PyMC:</p>
<div class="highlight-python"><pre>N = 10
x_0 = pymc.Normal(`x_0', mu=0, tau=1)

x = np.empty(N, dtype=object)
x[0] = x_0

for i in range(1, N):

    x[i] = pymc.Normal(`x_%i' % i, mu=x[i-1], tau=1)

@pymc.observed
def y(value=1, mu=x, tau=100):
    return pymc.normal_like(value, np.sum(mu**2), tau)</pre>
</div>
<p>PyMC automatically wraps array <span class="math">\(x\)</span> in an appropriate <tt class="docutils literal"><span class="pre">Container</span></tt> class.
The expression <tt class="docutils literal"><span class="pre">'x_%i'</span> <span class="pre">%</span> <span class="pre">i</span></tt> labels each <tt class="docutils literal"><span class="pre">Normal</span></tt> object in the container
with the appropriate index <span class="math">\(i\)</span>. For example, if <tt class="docutils literal"><span class="pre">i=1</span></tt>, the name of the
corresponding element becomes <tt class="docutils literal"><span class="pre">`x_1'</span></tt>.</p>
<p>Containers, like variables, have an attribute called <tt class="docutils literal"><span class="pre">value</span></tt>. This attribute
returns a copy of the (possibly nested) iterable that was passed into the
container function, but with each variable inside replaced with its
corresponding value.</p>
<p>Containers can be constructed from lists, tuples, dictionaries, Numpy arrays,
modules, sets or any object with a <tt class="docutils literal"><span class="pre">__dict__</span></tt> attribute. Variables and
non-variables can be freely mixed in these containers, and different types of
containers can be nested <a class="footnote-reference" href="#id17" id="id8">[3]</a>. Containers attempt to behave like the objects
they wrap. All containers are subclasses of <tt class="docutils literal"><span class="pre">ContainerBase</span></tt>.</p>
<p>Containers have the following useful attributes in addition to <tt class="docutils literal"><span class="pre">value</span></tt>:</p>
<blockquote>
<div><ul class="simple">
<li><tt class="docutils literal"><span class="pre">variables</span></tt></li>
<li><tt class="docutils literal"><span class="pre">stochastics</span></tt></li>
<li><tt class="docutils literal"><span class="pre">potentials</span></tt></li>
<li><tt class="docutils literal"><span class="pre">deterministics</span></tt></li>
<li><tt class="docutils literal"><span class="pre">data_stochastics</span></tt></li>
<li><tt class="docutils literal"><span class="pre">step_methods</span></tt>.</li>
</ul>
</div></blockquote>
<p>Each of these attributes is a set containing all the objects of each type in a
container, and within any containers in the container.</p>
</div>
<div class="section" id="the-potential-class">
<span id="potential"></span><h2>4.5. The Potential class<a class="headerlink" href="#the-potential-class" title="Permalink to this headline">¶</a></h2>
<p>The joint density corresponding to model (<a href="#equation-disastermodel">(?)</a>) can be written as follows:</p>
<div class="math">
\[\begin{eqnarray*}
    p(D,s,l,e) = p(D|s,l,e) p(s) p(l) p(e).
\end{eqnarray*}\]</div><p>Each factor in the joint distribution is a proper, normalized probability
distribution for one of the variables conditional on its parents. Such factors
are contributed by <tt class="docutils literal"><span class="pre">Stochastic</span></tt> objects.</p>
<p>In some cases, it&#8217;s nice to be able to modify the joint density by
incorporating terms that don&#8217;t correspond to probabilities of variables
conditional on parents, for example:</p>
<div class="math">
\[\begin{eqnarray*}
    p(x_0, x_2, \ldots x_{N-1}) \propto \prod_{i=0}^{N-2} \psi_i(x_i, x_{i+1}).
\end{eqnarray*}\]</div><p>In other cases we may want to add probability terms to existing models. For
example, suppose we want to constrain the difference between <span class="math">\(e\)</span> and
<span class="math">\(l\)</span> in (<a href="#equation-disastermodel">(?)</a>) to be less than 1, so that the joint density
becomes</p>
<div class="math">
\[\begin{eqnarray*}
    p(D,s,l,e) \propto p(D|s,l,e) p(s) p(l) p(e) I(|e-l|<1).
\end{eqnarray*}\]</div><p>Its possible to express this constraint by adding variables to the model, or by
grouping <span class="math">\(e\)</span> and <span class="math">\(l\)</span> to form a vector-valued variable, but it&#8217;s
uncomfortable to do so.</p>
<p>Arbitrary factors such as <span class="math">\(\psi\)</span> and the indicator function
<span class="math">\(I(|e-l|&lt;1)\)</span> are implemented by objects of class <tt class="docutils literal"><span class="pre">Potential</span></tt> (from
<a class="reference internal" href="references.html#lauritzen1990">[Lauritzen1990]</a> and <a class="reference internal" href="references.html#jordan2004">[Jordan2004]</a>, who call these terms &#8216;factor
potentials&#8217;). Bayesian hierarchical notation (cf model (<a href="#equation-disastermodel">(?)</a>))
doesn&#8217;t accomodate these potentials. They are often used in cases where there
is no natural dependence hierarchy, such as the first example above (which is
known as a Markov random field). They are also useful for expressing &#8216;soft
data&#8217; <a class="reference internal" href="references.html#christakos2002">[Christakos2002]</a> as in the second example below.</p>
<p>Potentials have one important attribute, <tt class="docutils literal"><span class="pre">logp</span></tt>, the log of their current
probability or probability density value given the values of their parents. The
only other additional attribute of interest is <tt class="docutils literal"><span class="pre">parents</span></tt>, a dictionary
containing the potential&#8217;s parents. Potentials have no methods. They have no
<tt class="docutils literal"><span class="pre">trace</span></tt> attribute, because they are not variables. They cannot serve as
parents of variables (for the same reason), so they have no <tt class="docutils literal"><span class="pre">children</span></tt>
attribute.</p>
<div class="section" id="an-example-of-soft-data">
<h3>4.5.1. An example of soft data<a class="headerlink" href="#an-example-of-soft-data" title="Permalink to this headline">¶</a></h3>
<p>The role of potentials can be confusing, so we will provide another example: we
have a dataset <span class="math">\(t\)</span> consisting of the days on which several marked animals
were recaptured. We believe that the probability <span class="math">\(S\)</span> that an animal is
not recaptured on any given day can be explained by a covariate vector
<span class="math">\(x\)</span>. We model this situation as follows:</p>
<div class="math">
\[\begin{eqnarray*}
    t_i|S_i \sim \text{Geometric}(S_i), & i=1\ldots N\\
    S_i = \text{logit}^{-1}(\beta x_i), &i=1\ldots N\\
    \beta\sim \text{N}(\mu_\beta, V_\beta).
\end{eqnarray*}\]</div><p>Now suppose we have some knowledge of other related experiments and we have a
good idea of what <span class="math">\(S\)</span> will be independent of the value of <span class="math">\(\beta\)</span>.
It&#8217;s not obvious how to work this &#8216;soft data&#8217;, because as we&#8217;ve written the
model <span class="math">\(S\)</span> is completely determined by <span class="math">\(\beta\)</span>. There are three
options within the strict Bayesian hierarchical framework:</p>
<ul class="simple">
<li>Express the soft data as an informative prior on <span class="math">\(\beta\)</span>.</li>
<li>Incorporate the data from the previous experiments explicitly into the model.</li>
<li>Refactor the model so that <span class="math">\(S\)</span> is at the bottom of the hierarchy, and
assign the prior directly.</li>
</ul>
<p>Factor potentials provide a convenient way to incorporate the soft data without
the need for such major modifications. We can simply modify the joint
distribution from</p>
<div class="math">
\[\begin{eqnarray*}
    p(t|S(x,\beta)) p(\beta)
\end{eqnarray*}\]</div><p>to</p>
<div class="math">
\[\begin{eqnarray*}
    \gamma(S) p(t|S(x,\beta)) p(\beta),
\end{eqnarray*}\]</div><p>where the value of <span class="math">\(\gamma\)</span> is large if <span class="math">\(S\)</span>&#8216;s value is plausible
(based on our external information) and small otherwise. We do not know the
normalizing constant for the new distribution, but we don&#8217;t need it to use most
popular fitting algorithms. It&#8217;s a good idea to check the induced priors on
<span class="math">\(S\)</span> and <span class="math">\(\beta\)</span> for sanity. This can be done in PyMC by fitting the
model with the data <span class="math">\(t\)</span> removed.</p>
<p>Its important to understand that <span class="math">\(\gamma\)</span> is not a variable, so it does
not have a value. That means, among other things, there will be no
<span class="math">\(\gamma\)</span> column in MCMC traces.</p>
</div>
<div class="section" id="creation-of-potentials">
<h3>4.5.2. Creation of Potentials<a class="headerlink" href="#creation-of-potentials" title="Permalink to this headline">¶</a></h3>
<p>There are two ways to create potentials:</p>
<dl class="docutils">
<dt><strong>Decorator</strong></dt>
<dd><p class="first">A potential can be created via a decorator in a way very similar to
<tt class="docutils literal"><span class="pre">Deterministic</span></tt>&#8216;s decorator interface:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="nd">@pymc.potential</span>
<span class="k">def</span> <span class="nf">psi_i</span><span class="p">(</span><span class="n">x_lo</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">x_hi</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]):</span>
    <span class="sd">&quot;&quot;&quot;A pair potential&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="o">-</span><span class="p">(</span><span class="n">xlo</span> <span class="o">-</span> <span class="n">xhi</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
</pre></div>
</div>
<p class="last">The function supplied should return the potential&#8217;s current
<em>log</em>-probability or <em>log</em>-density as a Numpy <tt class="docutils literal"><span class="pre">float</span></tt>. The <tt class="docutils literal"><span class="pre">potential</span></tt>
decorator can take <tt class="docutils literal"><span class="pre">verbose</span></tt> and <tt class="docutils literal"><span class="pre">cache_depth</span></tt> arguments like the
<tt class="docutils literal"><span class="pre">stochastic</span></tt> decorator.</p>
</dd>
<dt><strong>Direct</strong></dt>
<dd><p class="first">The same potential could be created directly as follows:</p>
<div class="last highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">psi_i_logp</span><span class="p">(</span><span class="n">x_lo</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">x_hi</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]):</span>
    <span class="k">return</span> <span class="o">-</span><span class="p">(</span><span class="n">xlo</span> <span class="o">-</span> <span class="n">xhi</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>

<span class="n">psi_i</span> <span class="o">=</span> <span class="n">pymc</span><span class="o">.</span><span class="n">Potential</span><span class="p">(</span><span class="n">logp</span> <span class="o">=</span> <span class="n">psi_i_logp</span><span class="p">,</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="s">&#39;psi_i&#39;</span><span class="p">,</span>
                    <span class="n">parents</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;xlo&#39;</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s">&#39;xhi&#39;</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]},</span>
                    <span class="n">doc</span> <span class="o">=</span> <span class="s">&#39;A pair potential&#39;</span><span class="p">,</span>
                    <span class="n">verbose</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
                    <span class="n">cache_depth</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</dd>
</dl>
</div>
</div>
<div class="section" id="graphing-models">
<span id="graphical"></span><h2>4.6. Graphing models<a class="headerlink" href="#graphing-models" title="Permalink to this headline">¶</a></h2>
<p>The function <tt class="docutils literal"><span class="pre">dag</span></tt> (or <tt class="docutils literal"><span class="pre">graph</span></tt>) in <tt class="docutils literal"><span class="pre">pymc.graph</span></tt> draws graphical
representations of <tt class="docutils literal"><span class="pre">Model</span></tt> (Chapter <a class="reference internal" href="modelfitting.html#chap-modelfitting"><em>Fitting Models</em></a>) instances using
<a class="reference external" href="http://www.graphviz.org/">GraphViz</a> via the Python package <a class="reference external" href="http://code.google.com/p/pydot/">PyDot</a>. See <a class="reference internal" href="references.html#lauritzen1990">[Lauritzen1990]</a> and <a class="reference internal" href="references.html#jordan2004">[Jordan2004]</a>
for more discussion of useful information that can be read off of graphical
models <a class="footnote-reference" href="#id18" id="id14">[4]</a>.</p>
<p>The symbol for stochastic variables is an ellipse. Parent-child relationships
are indicated by arrows. These arrows point from parent to child and are
labeled with the names assigned to the parents by the children. PyMC&#8217;s symbol
for deterministic variables is a downward-pointing triangle. A graphical
representation of model <a href="#equation-disastermodel">(?)</a> is shown in <a class="reference internal" href="tutorial.html#dag"><em>Directed acyclic graph of the relationships in the coal mining disaster model example.</em></a>. Note that
<span class="math">\(D\)</span> is shaded because it is flagged as data.</p>
<p>The symbol for factor potentials is a rectangle, as in the following model.
Factor potentials are usually associated with <em>undirected</em> grahical models. In
undirected representations, each parent of a potential is connected to every
other parent by an undirected edge. The undirected representation of the model
pictured above is much more compact: Directed or mixed graphical models can be
represented in an undirected form by &#8216;moralizing&#8217;, which is done by the
function <tt class="docutils literal"><span class="pre">pymc.graph.moral_graph</span></tt>.</p>
<div class="figure" id="pot">
<img alt="_images/PotExample.png" src="_images/PotExample.png" style="width: 800px;" />
<p class="caption">Directed graphical model example. Factor potentials are represented by
rectangles and stochastic variables by ellipses.</p>
</div>
</div>
<div class="section" id="class-lazyfunction-and-caching">
<span id="sec-caching"></span><h2>4.7. Class LazyFunction and caching<a class="headerlink" href="#class-lazyfunction-and-caching" title="Permalink to this headline">¶</a></h2>
<p>This section gives an overview of how PyMC computes log-probabilities. This is
advanced information that is not required in order to use PyMC.</p>
<p>The <tt class="docutils literal"><span class="pre">logp</span></tt> attributes of stochastic variables and potentials and the
<tt class="docutils literal"><span class="pre">value</span></tt> attributes of deterministic variables are wrappers for instances of
class <tt class="docutils literal"><span class="pre">LazyFunction</span></tt>. Lazy functions are wrappers for ordinary Python
functions. A lazy function <tt class="docutils literal"><span class="pre">L</span></tt> could be created from a function <tt class="docutils literal"><span class="pre">fun</span></tt> as
follows:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">L</span> <span class="o">=</span> <span class="n">pymc</span><span class="o">.</span><span class="n">LazyFunction</span><span class="p">(</span><span class="n">fun</span><span class="p">,</span> <span class="n">arguments</span><span class="p">)</span>
</pre></div>
</div>
<p>The argument <tt class="docutils literal"><span class="pre">arguments</span></tt> is a dictionary container; <tt class="docutils literal"><span class="pre">fun</span></tt> must accept
keyword arguments only. When <tt class="docutils literal"><span class="pre">L</span></tt>&#8216;s <tt class="docutils literal"><span class="pre">get()</span></tt> method is called, the return
value is the same as the call</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">fun</span><span class="p">(</span><span class="o">**</span><span class="n">arguments</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
</pre></div>
</div>
<p>Note that no arguments need to be passed to <tt class="docutils literal"><span class="pre">L.get</span></tt>; lazy functions memorize
their arguments.</p>
<p>Before calling <tt class="docutils literal"><span class="pre">fun</span></tt>, <tt class="docutils literal"><span class="pre">L</span></tt> will check the values of <tt class="docutils literal"><span class="pre">arguments.variables</span></tt>
against an internal cache. This comparison is done <em>by reference</em>, not by
value, and this is part of the reason why stochastic variables&#8217; values cannot
be updated in-place. If <tt class="docutils literal"><span class="pre">arguments.variables</span></tt>&#8216; values match a frame of the
cache, the corresponding output value is returned and <tt class="docutils literal"><span class="pre">fun</span></tt> is not called. If
a call to <tt class="docutils literal"><span class="pre">fun</span></tt> is needed, <tt class="docutils literal"><span class="pre">arguments.variables</span></tt>&#8216; values and the return
value replace the oldest frame in the cache. The depth of the cache can be set
using the optional init argument <tt class="docutils literal"><span class="pre">cache_depth</span></tt>, which defaults to 2.</p>
<p>Caching is helpful in MCMC, because variables&#8217; log-probabilities and values
tend to be queried multiple times for the same parental value configuration.
The default cache depth of 2 turns out to be most useful in
Metropolis-Hastings-type algorithms involving proposed values that may be
rejected.</p>
<p>Lazy functions are implemented in C using Pyrex, a language for writing Python
extensions.</p>
<p class="rubric">Footnotes</p>
<table class="docutils footnote" frame="void" id="id15" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id2">[1]</a></td><td>Note that the <tt class="docutils literal"><span class="pre">random</span></tt> method does not provide a Gibbs sample unless</td></tr>
</tbody>
</table>
<p>the variable has no children.</p>
<table class="docutils footnote" frame="void" id="id16" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id6">[2]</a></td><td>Note that deterministic variables have no <tt class="docutils literal"><span class="pre">observed</span></tt> flag. If a</td></tr>
</tbody>
</table>
<p>deterministic variable&#8217;s value were known, its parents would be restricted to
the inverse image of that value under the deterministic variable&#8217;s evaluation
function. This usage would be extremely difficult to support in general, but it
can be implemented for particular applications at the <tt class="docutils literal"><span class="pre">StepMethod</span></tt> level.</p>
<table class="docutils footnote" frame="void" id="id17" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id8">[3]</a></td><td>Nodes whose parents are containers make private shallow copies of those</td></tr>
</tbody>
</table>
<p>containers. This is done for technical reasons rather than to protect users
from accidental misuse.</p>
<table class="docutils footnote" frame="void" id="id18" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id14">[4]</a></td><td>Note that these authors do not consider deterministic variables.</td></tr>
</tbody>
</table>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="index.html">
              <img class="logo" src="_static/icon.png" alt="Logo"/>
            </a></p>
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">4. Building models</a><ul>
<li><a class="reference internal" href="#the-stochastic-class">4.1. The Stochastic class</a><ul>
<li><a class="reference internal" href="#creation-of-stochastic-variables">4.1.1. Creation of stochastic variables</a></li>
</ul>
</li>
<li><a class="reference internal" href="#data">4.2. Data</a><ul>
<li><a class="reference internal" href="#declaring-stochastic-variables-to-be-data">4.2.1. Declaring stochastic variables to be data</a></li>
</ul>
</li>
<li><a class="reference internal" href="#the-deterministic-class">4.3. The Deterministic class</a><ul>
<li><a class="reference internal" href="#creation-of-deterministic-variables">4.3.1. Creation of deterministic variables</a></li>
</ul>
</li>
<li><a class="reference internal" href="#containers">4.4. Containers</a></li>
<li><a class="reference internal" href="#the-potential-class">4.5. The Potential class</a><ul>
<li><a class="reference internal" href="#an-example-of-soft-data">4.5.1. An example of soft data</a></li>
<li><a class="reference internal" href="#creation-of-potentials">4.5.2. Creation of Potentials</a></li>
</ul>
</li>
<li><a class="reference internal" href="#graphing-models">4.6. Graphing models</a></li>
<li><a class="reference internal" href="#class-lazyfunction-and-caching">4.7. Class LazyFunction and caching</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="tutorial.html"
                        title="previous chapter">3. Tutorial</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="modelfitting.html"
                        title="next chapter">5. Fitting Models</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="_sources/modelbuilding.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="modelfitting.html" title="5. Fitting Models"
             >next</a> |</li>
        <li class="right" >
          <a href="tutorial.html" title="3. Tutorial"
             >previous</a> |</li>
        <li><a href="index.html">PyMC 2.3 documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2012, Christopher J. Fonnesbeck.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>