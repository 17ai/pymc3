

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>A Hierarchical model for Rugby prediction &mdash; PyMC3 3.0 documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="PyMC3 3.0 documentation" href="../index.html"/>
        <link rel="up" title="Examples" href="../examples.html"/>
        <link rel="next" title="Posterior Predictive Checks in PyMC3" href="posterior_predictive.html"/>
        <link rel="prev" title="Probabilistic Matrix Factorization for Making Personalized Recommendations" href="pmf-pymc.html"/> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> PyMC3
          

          
          </a>

          
            
            
              <div class="version">
                3.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../getting_started.html">Getting started</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../examples.html">Examples</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="BEST.html">Bayesian Estimation Supersedes the T-Test</a></li>
<li class="toctree-l2"><a class="reference internal" href="stochastic_volatility.html">Stochastic Volatility model</a></li>
<li class="toctree-l2"><a class="reference internal" href="GLM-linear.html">The Inference Button: Bayesian GLMs made easy with PyMC3</a></li>
<li class="toctree-l2"><a class="reference internal" href="GLM-robust.html">This world is far from Normal(ly distributed): Bayesian Robust Regression in PyMC3</a></li>
<li class="toctree-l2"><a class="reference internal" href="GLM-robust.html#robust-regression">Robust Regression</a></li>
<li class="toctree-l2"><a class="reference internal" href="GLM-robust-with-outlier-detection.html">PyMC3 Examples</a></li>
<li class="toctree-l2"><a class="reference internal" href="GLM-robust-with-outlier-detection.html#glm-robust-regression-with-outlier-detection">GLM Robust Regression with Outlier Detection</a></li>
<li class="toctree-l2"><a class="reference internal" href="GLM-robust-with-outlier-detection.html#setup">Setup</a></li>
<li class="toctree-l2"><a class="reference internal" href="GLM-robust-with-outlier-detection.html#create-conventional-ols-model">Create Conventional OLS Model</a></li>
<li class="toctree-l2"><a class="reference internal" href="GLM-robust-with-outlier-detection.html#create-robust-model-student-t-method">Create Robust Model: Student-T Method</a></li>
<li class="toctree-l2"><a class="reference internal" href="GLM-robust-with-outlier-detection.html#create-robust-model-with-outliers-hogg-method">Create Robust Model with Outliers: Hogg Method</a></li>
<li class="toctree-l2"><a class="reference internal" href="GLM-robust-with-outlier-detection.html#declare-outliers-and-compare-plots">Declare Outliers and Compare Plots</a></li>
<li class="toctree-l2"><a class="reference internal" href="GLM-model-selection.html">PyMC3 Examples</a></li>
<li class="toctree-l2"><a class="reference internal" href="GLM-model-selection.html#glm-model-selection">GLM Model Selection</a></li>
<li class="toctree-l2"><a class="reference internal" href="GLM-model-selection.html#setup">Setup</a></li>
<li class="toctree-l2"><a class="reference internal" href="GLM-model-selection.html#generate-toy-datasets">Generate Toy Datasets</a></li>
<li class="toctree-l2"><a class="reference internal" href="GLM-model-selection.html#demonstrate-simple-linear-model">Demonstrate Simple Linear Model</a></li>
<li class="toctree-l2"><a class="reference internal" href="GLM-model-selection.html#create-higher-order-linear-models">Create Higher-Order Linear Models</a></li>
<li class="toctree-l2"><a class="reference internal" href="GLM-model-selection.html#compare-deviance-information-criterion-dic">Compare Deviance Information Criterion [DIC]</a></li>
<li class="toctree-l2"><a class="reference internal" href="GLM-model-selection.html#compare-watanabe-akaike-information-criterion-waic">Compare Watanabe - Akaike Information Criterion [WAIC]</a></li>
<li class="toctree-l2"><a class="reference internal" href="GLM-model-selection.html#todo">TODO</a></li>
<li class="toctree-l2"><a class="reference internal" href="rolling_regression.html">Bayesian Rolling Regression in PyMC3</a></li>
<li class="toctree-l2"><a class="reference internal" href="GLM-hierarchical.html">The best of both worlds: Hierarchical Linear Regression in PyMC3</a></li>
<li class="toctree-l2"><a class="reference internal" href="GLM-hierarchical.html#the-models">The Models</a></li>
<li class="toctree-l2"><a class="reference internal" href="GLM-hierarchical.html#probabilistic-programming">Probabilistic Programming</a></li>
<li class="toctree-l2"><a class="reference internal" href="GLM-hierarchical.html#posterior-predictive-check">Posterior Predictive Check</a></li>
<li class="toctree-l2"><a class="reference internal" href="GLM-hierarchical.html#shrinkage">Shrinkage</a></li>
<li class="toctree-l2"><a class="reference internal" href="GLM-hierarchical.html#summary">Summary</a></li>
<li class="toctree-l2"><a class="reference internal" href="pmf-pymc.html">Probabilistic Matrix Factorization for Making Personalized Recommendations</a></li>
<li class="toctree-l2"><a class="reference internal" href="pmf-pymc.html#data">Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="pmf-pymc.html#methods">Methods</a></li>
<li class="toctree-l2"><a class="reference internal" href="pmf-pymc.html#evaluation">Evaluation</a></li>
<li class="toctree-l2"><a class="reference internal" href="pmf-pymc.html#results">Results</a></li>
<li class="toctree-l2"><a class="reference internal" href="pmf-pymc.html#summary">Summary</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">A Hierarchical model for Rugby prediction</a></li>
<li class="toctree-l2"><a class="reference internal" href="#motivation">Motivation</a></li>
<li class="toctree-l2"><a class="reference internal" href="#what-do-we-want-to-infer">What do we want to infer?</a></li>
<li class="toctree-l2"><a class="reference internal" href="#what-do-we-want">What do we want?</a></li>
<li class="toctree-l2"><a class="reference internal" href="#what-assumptions-do-we-know-for-our-generative-story">What assumptions do we know for our &#8216;generative story&#8217;?</a></li>
<li class="toctree-l2"><a class="reference internal" href="#the-model">The model.</a></li>
<li class="toctree-l2"><a class="reference internal" href="#building-of-the-model">Building of the model</a></li>
<li class="toctree-l2"><a class="reference internal" href="#results">Results</a></li>
<li class="toctree-l2"><a class="reference internal" href="#covariates">Covariates.</a></li>
<li class="toctree-l2"><a class="reference internal" href="posterior_predictive.html">Posterior Predictive Checks in PyMC3</a></li>
<li class="toctree-l2"><a class="reference internal" href="posterior_predictive.html#prediction">Prediction</a></li>
<li class="toctree-l2"><a class="reference internal" href="survival_analysis.html">Bayesian Survival Analysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="GP-smoothing.html">Gaussian Process (GP) smoothing</a></li>
<li class="toctree-l2"><a class="reference internal" href="dp_mix.html">Dirichlet process mixtures for density estimation</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../api.html">API Reference</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../index.html">PyMC3</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          

 



<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html">Docs</a> &raquo;</li>
      
          <li><a href="../examples.html">Examples</a> &raquo;</li>
      
    <li>A Hierarchical model for Rugby prediction</li>
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../_sources/notebooks/rugby_analytics.txt" rel="nofollow"> View page source</a>
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  
<style>
/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast,
.nboutput.nblast {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast + .nbinput {
    margin-top: -19px;
}

/* nice headers on first paragraph of info/warning boxes */
.admonition .first {
    margin: -12px;
    padding: 6px 12px;
    margin-bottom: 12px;
    color: #fff;
    line-height: 1;
    display: block;
}
.admonition.warning .first {
    background: #f0b37e;
}
.admonition.note .first {
    background: #6ab0de;
}
.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}
</style>
<div class="section" id="a-hierarchical-model-for-rugby-prediction">
<span id="a-hierarchical-model-for-rugby-prediction"></span><h1>A Hierarchical model for Rugby prediction<a class="headerlink" href="#a-hierarchical-model-for-rugby-prediction" title="Permalink to this headline">¶</a></h1>
<ul class="simple">
<li>&#64;Author: Peadar Coyle</li>
<li>&#64;email: peadarcoyle&#64;googlemail.com</li>
<li>&#64;date: 31/12/15</li>
</ul>
<p>I came across the following blog post on http://danielweitzenfeld.github.io/passtheroc/blog/2014/10/28/bayes-premier-league/</p>
<ul class="simple">
<li>Based on the work of <a class="reference external" href="www.statistica.it/gianluca/Research/BaioBlangiardo.pdf">Baio and Blangiardo</a>
In this example, we&#8217;re going to reproduce the first model described in the paper using PyMC3.</li>
</ul>
<p>Since I am a rugby fan I decide to apply the results of the paper Bayesian Football to the Six Nations.
Rugby is a physical sport popular worldwide.</p>
<ul class="simple">
<li>Six Nations consists of Italy, Ireland, Scotland, England, France and Wales</li>
<li>Game consists of scoring tries (similar to touch downs) or kicking the goal.</li>
<li>Average player is something like 100kg and 1.82m tall.</li>
<li>Paul O&#8217;Connell the Irish captain is Height: 6&#8217; 6&#8221; (1.98 m) Weight: 243 lbs (110 kg)</li>
</ul>
<p>We will use a data set only consisting of the Six Nations 2014 data, and use this to build a generative and explainable model about the Six Nations 2015.</p>
</div>
<div class="section" id="motivation">
<span id="motivation"></span><h1>Motivation<a class="headerlink" href="#motivation" title="Permalink to this headline">¶</a></h1>
<p>Your estimate of the strength of a team depends on your estimates of the other strengths</p>
<p>Ireland are a stronger team than Italy for example - but by how much?</p>
<p>Source for Results 2014 are Wikipedia.
I handcrafted these results
Small data</p>
<ul class="simple">
<li>We want to infer a latent parameter - that is the &#8216;strength&#8217; of a team based only on their <strong>scoring intensity</strong>, and all we have are their scores and results, we can&#8217;t accurately measure the &#8216;strength&#8217; of a team.</li>
<li>Probabilistic Programming is a brilliant paradigm for modeling these <strong>latent</strong> parameters</li>
</ul>
<div class="highlight-python"><div class="highlight"><pre><span></span>!date

import numpy as np
import pandas as pd
try:
    from StringIO import StringIO
except ImportError:
    from io import StringIO
%matplotlib inline
import pymc3 as pm, theano.tensor as tt
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">Sat</span> <span class="n">Apr</span>  <span class="mi">2</span> <span class="mi">16</span><span class="p">:</span><span class="mi">40</span><span class="p">:</span><span class="mi">04</span> <span class="n">BST</span> <span class="mi">2016</span>
</pre></div>
</div>
<p>This is a Rugby prediction exercise. So we&#8217;ll input some data</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">data_csv</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;home_team,away_team,home_score,away_score</span>
<span class="s2">Wales,Italy,23,15</span>
<span class="s2">France,England,26,24</span>
<span class="s2">Ireland,Scotland,28,6</span>
<span class="s2">Ireland,Wales,26,3</span>
<span class="s2">Scotland,England,0,20</span>
<span class="s2">France,Italy,30,10</span>
<span class="s2">Wales,France,27,6</span>
<span class="s2">Italy,Scotland,20,21</span>
<span class="s2">England,Ireland,13,10</span>
<span class="s2">Ireland,Italy,46,7</span>
<span class="s2">Scotland,France,17,19</span>
<span class="s2">England,Wales,29,18</span>
<span class="s2">Italy,England,11,52</span>
<span class="s2">Wales,Scotland,51,3</span>
<span class="s2">France,Ireland,20,22&quot;&quot;&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
<div class="section" id="what-do-we-want-to-infer">
<span id="what-do-we-want-to-infer"></span><h1>What do we want to infer?<a class="headerlink" href="#what-do-we-want-to-infer" title="Permalink to this headline">¶</a></h1>
<ul class="simple">
<li>We want to infer the latent paremeters (every team&#8217;s strength) that are generating the data we observe (the scorelines).</li>
<li>Moreover, we know that the scorelines are a noisy measurement of team strength, so ideally, we want a model that makes it easy to quantify our uncertainty about the underlying strengths.</li>
<li>Often we don&#8217;t know what the Bayesian Model is explicitly, so we have to &#8216;estimate&#8217; the Bayesian Model&#8217;</li>
<li>If we can&#8217;t solve something, approximate it.</li>
<li>Markov-Chain Monte Carlo (MCMC) instead draws samples from the posterior.</li>
<li>Fortunately, this algorithm can be applied to almost any model.</li>
</ul>
</div>
<div class="section" id="what-do-we-want">
<span id="what-do-we-want"></span><h1>What do we want?<a class="headerlink" href="#what-do-we-want" title="Permalink to this headline">¶</a></h1>
<p>We want to quantify our uncertainty
We want to also use this to generate a model
We want the answers as distributions not point estimates</p>
</div>
<div class="section" id="what-assumptions-do-we-know-for-our-generative-story">
<span id="what-assumptions-do-we-know-for-our-generative-story"></span><h1>What assumptions do we know for our &#8216;generative story&#8217;?<a class="headerlink" href="#what-assumptions-do-we-know-for-our-generative-story" title="Permalink to this headline">¶</a></h1>
<ul class="simple">
<li>We know that the Six Nations in Rugby only has 6 teams - they each play each other once</li>
<li>We have data from last year!</li>
<li>We also know that in sports scoring is modelled as a Poisson distribution</li>
<li>We consider home advantage to be a strong effect in sports</li>
</ul>
</div>
<div class="section" id="the-model">
<span id="the-model"></span><h1>The model.<a class="headerlink" href="#the-model" title="Permalink to this headline">¶</a></h1>
<p>The league is made up by a total of T= 6 teams, playing each other once
in a season. We indicate the number of points scored by the home and the away team in the g-th game of the season (15 games) as $y_{g1}$ and $y_{g2}$ respectively. </p>
The vector of observed counts $\mathbb{y} = (y_{g1}, y_{g2})$ is modelled as independent Poisson:
$y_{gi}| \theta_{gj} \tilde;;  Poisson(\theta_{gj})$
where the theta parameters represent the scoring intensity in the g-th game for the team playing at home (j=1) and away (j=2), respectively.</p></p>
<p>We model these parameters according to a formulation that has been used widely in the statistical literature, assuming a log-linear random effect model:
$$log \theta_{g1} = home + att_{h(g)} + def_{a(g)} $$
$$log \theta_{g2} = att_{a(g)} + def_{h(g)}$$</p>
<ul class="simple">
<li>The parameter home represents the advantage for the team hosting the game and we assume that this effect is constant for all the teams and throughout the season</li>
<li>The scoring intensity is determined jointly by the attack and defense ability of the two teams involved, represented by the parameters att and def, respectively</li>
<li>Conversely, for each t = 1, ..., T, the team-specific effects are modelled as exchangeable from a common distribution:</li>
<li>$att_{t} ; \tilde;; Normal(\mu_{att},\tau_{att})$ and $def_{t} ; \tilde;;Normal(\mu_{def},\tau_{def})$</li>
</ul>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">data_csv</span><span class="p">)</span>

<span class="n">teams</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">home_team</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
<span class="n">teams</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">teams</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;team&#39;</span><span class="p">])</span>
<span class="n">teams</span><span class="p">[</span><span class="s1">&#39;i&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">teams</span><span class="o">.</span><span class="n">index</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">teams</span><span class="p">,</span> <span class="n">left_on</span><span class="o">=</span><span class="s1">&#39;home_team&#39;</span><span class="p">,</span> <span class="n">right_on</span><span class="o">=</span><span class="s1">&#39;team&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;i&#39;</span><span class="p">:</span> <span class="s1">&#39;i_home&#39;</span><span class="p">})</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;team&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">teams</span><span class="p">,</span> <span class="n">left_on</span><span class="o">=</span><span class="s1">&#39;away_team&#39;</span><span class="p">,</span> <span class="n">right_on</span><span class="o">=</span><span class="s1">&#39;team&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;i&#39;</span><span class="p">:</span> <span class="s1">&#39;i_away&#39;</span><span class="p">})</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;team&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">observed_home_goals</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">home_score</span><span class="o">.</span><span class="n">values</span>
<span class="n">observed_away_goals</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">away_score</span><span class="o">.</span><span class="n">values</span>

<span class="n">home_team</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">i_home</span><span class="o">.</span><span class="n">values</span>
<span class="n">away_team</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">i_away</span><span class="o">.</span><span class="n">values</span>

<span class="n">num_teams</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">i_home</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">())</span>
<span class="n">num_games</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">home_team</span><span class="p">)</span>

<span class="n">g</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;i_away&#39;</span><span class="p">)</span>
<span class="n">att_starting_points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">away_score</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
<span class="n">g</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;i_home&#39;</span><span class="p">)</span>
<span class="n">def_starting_points</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">away_score</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
</pre></div>
</div>
<ul class="simple">
<li>We did some munging above and adjustments of the data to make it <strong>tidier</strong> for our model.</li>
<li>The log function to away scores and home scores is a standard trick in the sports analytics literature</li>
</ul>
</div>
<div class="section" id="building-of-the-model">
<span id="building-of-the-model"></span><h1>Building of the model<a class="headerlink" href="#building-of-the-model" title="Permalink to this headline">¶</a></h1>
<ul class="simple">
<li>We now build the model in PyMC3, specifying the global parameters, and the team-specific parameters and the likelihood function</li>
</ul>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Model</span><span class="p">()</span>
<span class="k">with</span> <span class="n">pm</span><span class="o">.</span><span class="n">Model</span><span class="p">()</span> <span class="k">as</span> <span class="n">model</span><span class="p">:</span>
    <span class="c1"># global model parameters</span>
    <span class="n">home</span>        <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="s1">&#39;home&#39;</span><span class="p">,</span>      <span class="mi">0</span><span class="p">,</span> <span class="o">.</span><span class="mo">0001</span><span class="p">)</span>
    <span class="n">tau_att</span>     <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Gamma</span><span class="p">(</span><span class="s1">&#39;tau_att&#39;</span><span class="p">,</span>   <span class="o">.</span><span class="mi">1</span><span class="p">,</span> <span class="o">.</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">tau_def</span>     <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Gamma</span><span class="p">(</span><span class="s1">&#39;tau_def&#39;</span><span class="p">,</span>   <span class="o">.</span><span class="mi">1</span><span class="p">,</span> <span class="o">.</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">intercept</span>   <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="s1">&#39;intercept&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">.</span><span class="mo">0001</span><span class="p">)</span>
    
    <span class="c1"># team-specific model parameters</span>
    <span class="n">atts_star</span>   <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="s2">&quot;atts_star&quot;</span><span class="p">,</span> 
                           <span class="n">mu</span>   <span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                           <span class="n">tau</span>  <span class="o">=</span><span class="n">tau_att</span><span class="p">,</span> 
                           <span class="n">shape</span><span class="o">=</span><span class="n">num_teams</span><span class="p">)</span>
    <span class="n">defs_star</span>   <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="s2">&quot;defs_star&quot;</span><span class="p">,</span> 
                           <span class="n">mu</span>   <span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                           <span class="n">tau</span>  <span class="o">=</span><span class="n">tau_def</span><span class="p">,</span>  
                           <span class="n">shape</span><span class="o">=</span><span class="n">num_teams</span><span class="p">)</span> 
 
    <span class="n">atts</span>        <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Deterministic</span><span class="p">(</span><span class="s1">&#39;atts&#39;</span><span class="p">,</span> <span class="n">atts_star</span> <span class="o">-</span> <span class="n">tt</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">atts_star</span><span class="p">))</span>
    <span class="n">defs</span>        <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Deterministic</span><span class="p">(</span><span class="s1">&#39;defs&#39;</span><span class="p">,</span> <span class="n">defs_star</span> <span class="o">-</span> <span class="n">tt</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">defs_star</span><span class="p">))</span>
    <span class="n">home_theta</span>  <span class="o">=</span> <span class="n">tt</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">intercept</span> <span class="o">+</span> <span class="n">home</span> <span class="o">+</span> <span class="n">atts</span><span class="p">[</span><span class="n">home_team</span><span class="p">]</span> <span class="o">+</span> <span class="n">defs</span><span class="p">[</span><span class="n">away_team</span><span class="p">])</span>
    <span class="n">away_theta</span>  <span class="o">=</span> <span class="n">tt</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">intercept</span> <span class="o">+</span> <span class="n">atts</span><span class="p">[</span><span class="n">away_team</span><span class="p">]</span> <span class="o">+</span> <span class="n">defs</span><span class="p">[</span><span class="n">home_team</span><span class="p">])</span>
    
    <span class="c1"># likelihood of observed data</span>
    <span class="n">home_points</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Poisson</span><span class="p">(</span><span class="s1">&#39;home_points&#39;</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="n">home_theta</span><span class="p">,</span> <span class="n">observed</span><span class="o">=</span><span class="n">observed_home_goals</span><span class="p">)</span>
    <span class="n">away_points</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Poisson</span><span class="p">(</span><span class="s1">&#39;away_points&#39;</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="n">away_theta</span><span class="p">,</span> <span class="n">observed</span><span class="o">=</span><span class="n">observed_away_goals</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">Applied</span> <span class="n">log</span><span class="o">-</span><span class="n">transform</span> <span class="n">to</span> <span class="n">tau_att</span> <span class="ow">and</span> <span class="n">added</span> <span class="n">transformed</span> <span class="n">tau_att_log</span> <span class="n">to</span> <span class="n">model</span><span class="o">.</span>
<span class="n">Applied</span> <span class="n">log</span><span class="o">-</span><span class="n">transform</span> <span class="n">to</span> <span class="n">tau_def</span> <span class="ow">and</span> <span class="n">added</span> <span class="n">transformed</span> <span class="n">tau_def_log</span> <span class="n">to</span> <span class="n">model</span><span class="o">.</span>
</pre></div>
</div>
<ul class="simple">
<li>We specified the model and the likelihood function</li>
<li>All this runs on a Theano graph under the hood</li>
<li>Now we need to fit our model using the Maximum A Posteriori algorithm to decide where to start out No U Turn Sampler</li>
</ul>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">model</span><span class="p">:</span>

    <span class="n">start</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">find_MAP</span><span class="p">()</span>
    <span class="n">step</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">NUTS</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="n">start</span><span class="p">)</span>
    <span class="n">trace</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="n">start</span><span class="p">)</span>

    <span class="n">pm</span><span class="o">.</span><span class="n">traceplot</span><span class="p">(</span><span class="n">trace</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span> <span class="p">[</span><span class="o">-----------------</span><span class="mi">100</span><span class="o">%-----------------</span><span class="p">]</span> <span class="mi">2000</span> <span class="n">of</span> <span class="mi">2000</span> <span class="n">complete</span> <span class="ow">in</span> <span class="mf">5.3</span> <span class="n">sec</span>
</pre></div>
</div>
<p><img alt="png" src="../_images/rugby_analytics_16_1.png" /></p>
</div>
<div class="section" id="results">
<span id="results"></span><h1>Results<a class="headerlink" href="#results" title="Permalink to this headline">¶</a></h1>
<p>From the above we can start to understand the different distributions of attacking strength and defensive strength.
These are probabilistic estimates and help us better understand the uncertainty in sports analytics</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">pm</span><span class="o">.</span><span class="n">forestplot</span><span class="p">(</span><span class="n">trace</span><span class="p">,</span> <span class="n">varnames</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;atts&#39;</span><span class="p">],</span> <span class="n">ylabels</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;France&#39;</span><span class="p">,</span> <span class="s1">&#39;Ireland&#39;</span><span class="p">,</span> <span class="s1">&#39;Scotland&#39;</span><span class="p">,</span> <span class="s1">&#39;Italy&#39;</span><span class="p">,</span> <span class="s1">&#39;England&#39;</span><span class="p">,</span> <span class="s1">&#39;Wales&#39;</span><span class="p">],</span> <span class="n">main</span><span class="o">=</span><span class="s2">&quot;Team Offense&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">gridspec</span><span class="o">.</span><span class="n">GridSpec</span> <span class="n">at</span> <span class="mh">0x1205adc50</span><span class="o">&gt;</span>
</pre></div>
</div>
<p><img alt="png" src="../_images/rugby_analytics_18_1.png" /></p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">pm</span><span class="o">.</span><span class="n">forestplot</span><span class="p">(</span><span class="n">trace</span><span class="p">,</span> <span class="n">varnames</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;defs&#39;</span><span class="p">],</span> <span class="n">ylabels</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;France&#39;</span><span class="p">,</span> <span class="s1">&#39;Ireland&#39;</span><span class="p">,</span> <span class="s1">&#39;Scotland&#39;</span><span class="p">,</span> <span class="s1">&#39;Italy&#39;</span><span class="p">,</span> <span class="s1">&#39;England&#39;</span><span class="p">,</span> <span class="s1">&#39;Wales&#39;</span><span class="p">],</span> <span class="n">main</span><span class="o">=</span><span class="s2">&quot;Team Defense&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">gridspec</span><span class="o">.</span><span class="n">GridSpec</span> <span class="n">at</span> <span class="mh">0x125972438</span><span class="o">&gt;</span>
</pre></div>
</div>
<p><img alt="png" src="../_images/rugby_analytics_19_1.png" /></p>
</div>
<div class="section" id="covariates">
<span id="covariates"></span><h1>Covariates.<a class="headerlink" href="#covariates" title="Permalink to this headline">¶</a></h1>
<p>We should do some exploration. of the variables too</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">df_trace</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">trace_to_dataframe</span><span class="p">(</span><span class="n">trace</span><span class="p">[:</span><span class="mi">1000</span><span class="p">])</span>


</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">seaborn</span> <span class="kn">as</span> <span class="nn">sns</span>
<span class="n">df_trace_att</span> <span class="o">=</span> <span class="n">df_trace</span><span class="p">[[</span><span class="s1">&#39;atts_star__0&#39;</span><span class="p">,</span><span class="s1">&#39;atts_star__1&#39;</span><span class="p">,</span>
 <span class="s1">&#39;atts_star__2&#39;</span><span class="p">,</span>
 <span class="s1">&#39;atts_star__3&#39;</span><span class="p">,</span>
 <span class="s1">&#39;atts_star__4&#39;</span><span class="p">,</span>
 <span class="s1">&#39;atts_star__5&#39;</span><span class="p">]]</span>
<span class="n">df_trace_att</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;atts_star__0&#39;</span><span class="p">:</span><span class="s1">&#39;atts_star_france&#39;</span><span class="p">,</span><span class="s1">&#39;atts_star__1&#39;</span><span class="p">:</span><span class="s1">&#39;atts_star_ireland&#39;</span><span class="p">,</span>
 <span class="s1">&#39;atts_star__2&#39;</span><span class="p">:</span><span class="s1">&#39;atts_star_scotland&#39;</span><span class="p">,</span>
 <span class="s1">&#39;atts_star__3&#39;</span><span class="p">:</span><span class="s1">&#39;atts_star_italy&#39;</span><span class="p">,</span>
 <span class="s1">&#39;atts_star__4&#39;</span><span class="p">:</span><span class="s1">&#39;atts_star_england&#39;</span><span class="p">,</span>
 <span class="s1">&#39;atts_star__5&#39;</span><span class="p">:</span><span class="s1">&#39;atts_star_wales&#39;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">pairplot</span><span class="p">(</span><span class="n">df_trace_att</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">peadarcoyle</span><span class="o">/</span><span class="n">anaconda</span><span class="o">/</span><span class="n">envs</span><span class="o">/</span><span class="n">pymc3_examples</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="o">.</span><span class="mi">5</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">pandas</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">frame</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">2697</span><span class="p">:</span> <span class="n">SettingWithCopyWarning</span><span class="p">:</span> 
<span class="n">A</span> <span class="n">value</span> <span class="ow">is</span> <span class="n">trying</span> <span class="n">to</span> <span class="n">be</span> <span class="nb">set</span> <span class="n">on</span> <span class="n">a</span> <span class="n">copy</span> <span class="n">of</span> <span class="n">a</span> <span class="nb">slice</span> <span class="kn">from</span> <span class="nn">a</span> <span class="n">DataFrame</span>

<span class="n">See</span> <span class="n">the</span> <span class="n">caveats</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">documentation</span><span class="p">:</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">pandas</span><span class="o">.</span><span class="n">pydata</span><span class="o">.</span><span class="n">org</span><span class="o">/</span><span class="n">pandas</span><span class="o">-</span><span class="n">docs</span><span class="o">/</span><span class="n">stable</span><span class="o">/</span><span class="n">indexing</span><span class="o">.</span><span class="n">html</span><span class="c1">#indexing-view-versus-copy</span>
  <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</pre></div>
</div>
<p><img alt="png" src="../_images/rugby_analytics_22_1.png" /></p>
<p>We observe that there isn&#8217;t a lot of correlation between these covariates, other than the weaker teams like Italy have a more negative distribution of these variables.
Nevertheless this is a good method to get some insight into how the variables are behaving.</p>
</div>


           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="posterior_predictive.html" class="btn btn-neutral float-right" title="Posterior Predictive Checks in PyMC3" accesskey="n">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="pmf-pymc.html" class="btn btn-neutral" title="Probabilistic Matrix Factorization for Making Personalized Recommendations" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2016, John Salvatier, Christopher Fonnesbeck, Thomas Wiecki.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'3.0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>