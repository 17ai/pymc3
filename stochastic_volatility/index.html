<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <meta name="author" content="PyMC devs">
        
        <link rel="shortcut icon" href="../img/favicon.ico">

	<title>Stochastic Volatility - PyMC3</title>

        <link href="../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../css/font-awesome-4.5.0.css" rel="stylesheet">
        <link href="../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="../css/highlight.css">
        <link href="../source/_build/html/_static/basic.css" rel="stylesheet">
        <link href="../source/_build/html/_static/pygments.css" rel="stylesheet">
        <link href="../source/_build/html/_static/css/badge_only.css" rel="stylesheet">
        <link href="../source/_build/html/_static/css/theme.css" rel="stylesheet">

        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->

        
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            

            <!-- Main title -->
            <a class="navbar-brand" href="..">PyMC3</a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
            
                <!-- Main navigation -->
                <ul class="nav navbar-nav">
                
                
                    <li >
                        <a href="..">Overview</a>
                    </li>
                
                
                
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Tutorial <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            
<li >
    <a href="../getting_started/">Getting started</a>
</li>

                        
                        </ul>
                    </li>
                
                
                
                    <li class="dropdown active">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Examples <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            
<li >
    <a href="../BEST/">BEST</a>
</li>

                        
                            
<li class="active">
    <a href="./">Stochastic Volatility</a>
</li>

                        
                            
<li >
    <a href="../GLM-linear/">Linear Regression</a>
</li>

                        
                            
<li >
    <a href="../GLM-robust/">Robust Regression</a>
</li>

                        
                            
<li >
    <a href="../GLM-robust-with-outlier-detection/">Robust Regression with Outlier Detection</a>
</li>

                        
                            
<li >
    <a href="../GLM-model-selection/">Model Selection for Regression using DIC and WAIC</a>
</li>

                        
                            
<li >
    <a href="../rolling_regression/">Rolling Regression</a>
</li>

                        
                            
<li >
    <a href="../GLM-hierarchical/">Hierarchical linear regression</a>
</li>

                        
                            
<li >
    <a href="../pmf-pymc/">Probabilistic Matrix Factorization</a>
</li>

                        
                            
<li >
    <a href="../rugby_analytics/">Rugby Analytics example</a>
</li>

                        
                            
<li >
    <a href="../posterior_predictive/">Posterior Predictive checks and prediction</a>
</li>

                        
                            
<li >
    <a href="../survival_analysis/">Survival Analysis</a>
</li>

                        
                            
<li >
    <a href="../GP-smoothing/">Gaussian Process (GP) smoothing</a>
</li>

                        
                            
<li >
    <a href="../Bayesian_LogReg/">Bayesian Logistic Regression for predicting salary</a>
</li>

                        
                            
<li >
    <a href="../dp_mix/">Density Estimation with Dirichlet Process Mixtures</a>
</li>

                        
                        </ul>
                    </li>
                
                
                </ul>
            

            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                        <i class="fa fa-search"></i> Search
                    </a>
                </li>
                
                    <li >
                        <a rel="next" href="../BEST/">
                            <i class="fa fa-arrow-left"></i> Previous
                        </a>
                    </li>
                    <li >
                        <a rel="prev" href="../GLM-linear/">
                            Next <i class="fa fa-arrow-right"></i>
                        </a>
                    </li>
                
                
                    <li>
                        <a href="https://github.com/pymc-devs/pymc3">
                            
                                <i class="fa fa-github"></i>
                            
                            GitHub
                        </a>
                    </li>
                
            </ul>
        </div>
    </div>
</div>

        <div class="container">
            
                <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
    
        <li class="main active"><a href="#stochastic-volatility-model">Stochastic Volatility model</a></li>
        
            <li><a href="#build-model">Build Model</a></li>
        
            <li><a href="#fit-model">Fit Model</a></li>
        
            <li><a href="#references">References</a></li>
        
    
    </ul>
</div></div>
                <div class="col-md-9" role="main">

<h1 id="stochastic-volatility-model">Stochastic Volatility model</h1>
<pre><code class="python">import numpy as np
import pymc3 as pm
from pymc3.distributions.timeseries import GaussianRandomWalk

from scipy.sparse import csc_matrix
from scipy import optimize

%pylab inline
</code></pre>

<pre><code>Populating the interactive namespace from numpy and matplotlib


:0: FutureWarning: IPython widgets are experimental and may change in the future.
</code></pre>
<p>Asset prices have time-varying volatility (variance of day over day <code>returns</code>). In some periods, returns are highly variable, while in others very stable. Stochastic volatility models model this with a latent volatility variable, modeled as a stochastic process. The following model is similar to the one described in the No-U-Turn Sampler paper, Hoffman (2011) p21.</p>
<p><mathjax>$$ \sigma \sim Exponential(50) $$</mathjax></p>
<p><mathjax>$$ \nu \sim Exponential(.1) $$</mathjax></p>
<p><mathjax>$$ s_i \sim Normal(s_{i-1}, \sigma^{-2}) $$</mathjax></p>
<p><mathjax>$$ log(\frac{y_i}{y_{i-1}}) \sim t(\nu, 0, exp(-2 s_i)) $$</mathjax></p>
<p>Here, <mathjax>$y$</mathjax> is the daily return series and <mathjax>$s$</mathjax> is the latent log volatility process.</p>
<h2 id="build-model">Build Model</h2>
<p>First we load some daily returns of the S&amp;P 500.</p>
<pre><code class="python">n = 400
returns = np.genfromtxt(&quot;data/SP500.csv&quot;)[-n:]
returns[:5]
</code></pre>

<pre><code>array([-0.00637 , -0.004045, -0.02547 ,  0.005102, -0.047733])
</code></pre>
<pre><code class="python">plt.plot(returns)
</code></pre>

<pre><code>[&lt;matplotlib.lines.Line2D at 0xaeaec1cc&gt;]
</code></pre>
<p><img alt="png" src="../stochastic_volatility_files/stochastic_volatility_6_1.png" /></p>
<p>Specifying the model in pymc3 mirrors its statistical specification. </p>
<pre><code class="python">model = pm.Model()
with model:
    sigma = pm.Exponential('sigma', 1./.02, testval=.1)

    nu = pm.Exponential('nu', 1./10)
    s = GaussianRandomWalk('s', sigma**-2, shape=n)

    r = pm.StudentT('r', nu, lam=pm.exp(-2*s), observed=returns)
</code></pre>

<h2 id="fit-model">Fit Model</h2>
<p>For this model, the full maximum a posteriori (MAP) point is degenerate and has infinite density. However, if we fix <code>log_sigma</code> and <code>nu</code> it is no longer degenerate, so we find the MAP with respect to the volatility process, 's', keeping <code>log_sigma</code> and <code>nu</code> constant at their default values. </p>
<p>We use L-BFGS because it is more efficient for high dimensional functions (<code>s</code> has n elements).</p>
<pre><code class="python">with model:
    start = pm.find_MAP(vars=[s], fmin=optimize.fmin_l_bfgs_b)
</code></pre>

<p>We do a short initial run to get near the right area, then start again using a new Hessian at the new starting point to get faster sampling due to better scaling. We do a short run since this is an interactive example.</p>
<pre><code class="python">with model:
    step = pm.NUTS(vars=[s, nu,sigma],scaling=start, gamma=.25)
    start2 = pm.sample(100, step, start=start)[-1]

    # Start next run at the last sampled position.
    step = pm.NUTS(vars=[s, nu,sigma],scaling=start2, gamma=.55)
    trace = pm.sample(2000, step, start=start2)
</code></pre>

<pre><code> [-----------------100%-----------------] 2001 of 2000 complete in 368.9 sec

/usr/lib/python3.4/importlib/_bootstrap.py:321: RuntimeWarning: numpy.ndarray size changed, may indicate binary incompatibility
  return f(*args, **kwds)
</code></pre>
<pre><code class="python">figsize(12,6)
pm.traceplot(trace, model.vars[:-1]);
</code></pre>

<p><img alt="png" src="../stochastic_volatility_files/stochastic_volatility_14_0.png" /></p>
<pre><code class="python">figsize(12,6)
title(str(s))
plot(trace[s][::10].T,'b', alpha=.03);
xlabel('time')
ylabel('log volatility')
</code></pre>

<pre><code>&lt;matplotlib.text.Text at 0xac04168c&gt;
</code></pre>
<p><img alt="png" src="../stochastic_volatility_files/stochastic_volatility_15_1.png" /></p>
<p>Looking at the returns over time and overlaying the estimated standard deviation we can see how the model tracks the volatility over time.</p>
<pre><code class="python">plot(returns)
plot(np.exp(trace[s][::10].T), 'r', alpha=.03);
sd = np.exp(trace[s].T)
plot(-np.exp(trace[s][::10].T), 'r', alpha=.03);
xlabel('time')
ylabel('returns')
</code></pre>

<pre><code>&lt;matplotlib.text.Text at 0xaab3854c&gt;
</code></pre>
<p><img alt="png" src="../stochastic_volatility_files/stochastic_volatility_17_1.png" /></p>
<h2 id="references">References</h2>
<ol>
<li>Hoffman &amp; Gelman. (2011). <a href="http://arxiv.org/abs/1111.4246">The No-U-Turn Sampler: Adaptively Setting Path Lengths in Hamiltonian Monte Carlo</a>. </li>
</ol></div>
            
        </div>

        <footer class="col-md-12">
            <hr>
            
            <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>

        <script src="../js/jquery-1.10.2.min.js"></script>
        <script src="../js/bootstrap-3.0.3.min.js"></script>
        <script src="../js/highlight.pack.js"></script>
        <script>var base_url = '..';</script>
        <script data-main="../mkdocs/js/search.js" src="../mkdocs/js/require.js"></script>
        <script src="../js/base.js"></script>
        <script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_HTML"></script>
        <script src="../js/mathjaxhelper.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                        <h4 class="modal-title" id="exampleModalLabel">Search</h4>
                    </div>
                    <div class="modal-body">
                        <p>
                            From here you can search these documents. Enter
                            your search terms below.
                        </p>
                        <form role="form">
                            <div class="form-group">
                                <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query">
                            </div>
                        </form>
                        <div id="mkdocs-search-results"></div>
                    </div>
                    <div class="modal-footer">
                    </div>
                </div>
            </div>
        </div>

    </body>
</html>
